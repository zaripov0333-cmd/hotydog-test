<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hoty Dogy Audit</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI;}
body{background:linear-gradient(135deg,#FFD43B,#FFC107);}
.header{
background:#000;color:#FFD43B;
padding:15px;display:flex;
justify-content:space-between;
font-weight:bold;font-size:18px;
}
.container{padding:15px;}
.menu{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
.btn{
background:#fff;padding:18px;
border-radius:18px;text-align:center;
font-weight:bold;cursor:pointer;
box-shadow:0 8px 25px rgba(0,0,0,0.25);
transition:0.2s;
}
.btn:hover{transform:scale(1.03);}
.card{
background:#fff;padding:15px;
border-radius:18px;margin-bottom:12px;
box-shadow:0 6px 20px rgba(0,0,0,0.15);
}
.back{
background:#000;color:#FFD43B;
padding:6px 12px;border-radius:20px;
display:inline-block;margin-bottom:10px;
cursor:pointer;
}
button{
margin:4px;padding:6px 12px;
border:none;border-radius:8px;
background:#000;color:#FFD43B;
cursor:pointer;
}
select,input{
width:100%;padding:8px;
margin:6px 0;border-radius:8px;
}
img{
width:100%;
max-height:280px;
object-fit:cover;
border-radius:12px;
margin-top:8px;
cursor:pointer;
}
.good{background:green!important;}
.bad{background:red!important;}
.locked{opacity:0.6;}
.scoreGreen{color:green;font-weight:bold;}
.scoreRed{color:red;font-weight:bold;}
</style>
</head>

<body>

<div class="header">
Hoty Dogy Audit
<div onclick="logout()">Chiqish</div>
</div>

<div class="container">
<select id="monthSelect" onchange="changeMonth()"></select>
<div id="menu" class="menu"></div>
<div id="content"></div>
</div>

<script>

/* ================= SECURITY ROLE ================= */

function hash(str){
  let h=0;
  for(let i=0;i<str.length;i++){
    h = Math.imul(31,h)+str.charCodeAt(i)|0;
  }
  return h.toString();
}

function getRole(){
  try{
    const raw=localStorage.getItem("auth");
    if(!raw)return null;
    const data=JSON.parse(atob(raw));
    if(data.key!=="HD_secure_2025")return null;
    return data.role;
  }catch{return null;}
}

const role=getRole();
if(!role){
  localStorage.clear();
  window.location="index.html";
}

/* ================= STORAGE SIGNATURE ================= */

function saveData(data){
  const payload=JSON.stringify(data);
  const signature=hash(payload+"HotySecretKey");
  localStorage.setItem("auditSecure", btoa(JSON.stringify({payload,signature})));
}

function getData(){
  const raw=localStorage.getItem("auditSecure");
  if(!raw)return {};
  try{
    const obj=JSON.parse(atob(raw));
    if(hash(obj.payload+"HotySecretKey")!==obj.signature){
      alert("Ma'lumot buzilgan!");
      localStorage.clear();
      location.reload();
      return {};
    }
    return JSON.parse(obj.payload);
  }catch{return {};}
}

/* ================= BASIC DATA ================= */

const branches = ["Ц1","Шевченко","Чилонзор","Нехт","Эко","ИТ парк"];
const questions = [

{ text:"Restoran oldidagi bruschatka butun, mustahkam va toza.", minus:1 },
{ text:"XotyDogy yorlig'i toza va soz.", minus:1 },
{ text:"Chiqindi baklari toza va 3/4 dan oshmagan.", minus:1 },
{ text:"Zina va pandus toza va shikastlanmagan.", minus:1 },
{ text:"Kirish guruhlari texnik soz.", minus:1 },
{ text:"Vitrajli derazalar toza.", minus:1 },
{ text:"Dekor devorlarga mahkam yopishtirilgan.", minus:2 },
{ text:"Barcha yoritish vositalari ishlaydi.", minus:1 },
{ text:"Eshik oldidagi gilam toza.", minus:1 },
{ text:"Stollar toza va salfetnitsa mavjud.", minus:2 },
{ text:"Zal atmosferasi yaxshi.", minus:1 },
{ text:"Zov-klient ishlaydi.", minus:1 },
{ text:"Axlat idishlari toza.", minus:1 },
{ text:"Devorlar eskirmagan.", minus:1 },
{ text:"Pollar toza.", minus:1 },
{ text:"Bolalar o‘rindig‘i toza.", minus:2 },
{ text:"Banner butun.", minus:1 },
{ text:"Menu aktual.", minus:1 },
{ text:"TV Board aktual.", minus:1 },
{ text:"Flayerlar mavjud.", minus:2 },
{ text:"Xolodilnik toza va +6°.", minus:2 },
{ text:"Kassa zonasi standartga mos.", minus:2 },
{ text:"Buyurtma yig‘ish zonasi standart.", minus:2 },
{ text:"Buyurtma aniqligi.", minus:2 },
{ text:"Polda saqlash yo‘q.", minus:1 },
{ text:"Kassada FIFO.", minus:1 },
{ text:"Ikkinchi darajali qadoq kassada yo‘q.", minus:1 },
{ text:"Kassada shaxsiy narsalar yo‘q.", minus:2 },
{ text:"Stop-list mavjud.", minus:2 },
{ text:"Podnos va tarelkalar toza.", minus:2 },
{ text:"TV va boardlar changsiz.", minus:1 },
{ text:"Postmix apparati toza.", minus:1 },
{ text:"Chiqindi chelagi toza.", minus:1 },
{ text:"Oshxona pollari toza.", minus:1 },
{ text:"Oshxona harorati ≤26°.", minus:2 },
{ text:"Mahsulotlar FIFO asosida.", minus:1 },
{ text:"Meklayn toza.", minus:1 },
{ text:"Meklayn harorati ≤+6°.", minus:1 },
{ text:"Ikkinchi qadoq oshxonada yo‘q.", minus:1 },
{ text:"Toster, frityur toza.", minus:2 },
{ text:"Zagatovka stoli toza.", minus:1 },
{ text:"Mahsulot saqlash standart.", minus:2 },
{ text:"Osma javonlar toza.", minus:1 },
{ text:"Hisobdan chiqarish o‘z vaqtida.", minus:5 },
{ text:"Sabzavot rakovina toza.", minus:1 },
{ text:"Tarozilar toza.", minus:2 },
{ text:"FIFO gastronom idishlar.", minus:2 },
{ text:"Mahsulot harorati ≤+6°.", minus:2 },
{ text:"Ombor stelajlari toza.", minus:1 },
{ text:"Eshiklar soz.", minus:1 },
{ text:"Tovar qo‘shnichiligi saqlangan.", minus:2 },
{ text:"Muzlatkich harorati -10°/-18°.", minus:2 },
{ text:"Polda hech narsa saqlanmaydi.", minus:1 },
{ text:"Sanitariya qo‘pol buzilishi yo‘q.", minus:2 },
{ text:"Restoran tayyorligi.", minus:2 },
{ text:"Xodimlar qo‘l yuvish qoidasi.", minus:5 },
{ text:"Simlar chiqmagan.", minus:2 },
{ text:"Xodim shaxsiy fayli mavjud.", minus:2 },
{ text:"Telefonlar topshirilgan.", minus:2 },
{ text:"Xodim tashqi ko‘rinishi standart.", minus:2 },
{ text:"Ognetushitel yashil zona.", minus:1 },
{ text:"Razdevalka tartibli.", minus:2 },
{ text:"Restoranda yoriq yo‘q.", minus:1 },
{ text:"Latta matolar to‘g‘ri saqlanadi.", minus:2 },
{ text:"Inventar toza.", minus:5 },
{ text:"Zararkunanda yo‘q.", minus:5 },
{ text:"Qo‘l yuvish sovuni bor.", minus:5 },
{ text:"Formasiz yurish yo‘q.", minus:5 },
{ text:"Mahsulot sifati yaxshi.", minus:5 },
{ text:"Yaroqlilik muddati o‘tmagan.", minus:20 },
{ text:"Markirovka ustidan markirovka yo‘q.", minus:20 },
{ text:"Markirovka mavjud.", minus:20 },
{ text:"Smena mas'ul shaxs mavjud.", minus:20 }

];

/* ================= MONTH ================= */

function getMonth(){
let d=new Date();
return d.getFullYear()+"-"+(d.getMonth()+1);
}
let currentMonth=getMonth();

function loadMonths(){
let data=getData();
if(!data[currentMonth]){
data[currentMonth]={};
saveData(data);
}
let select=document.getElementById("monthSelect");
select.innerHTML="";
Object.keys(data).forEach(m=>{
select.innerHTML+=`<option value="${m}">${m}</option>`;
});
select.value=currentMonth;
}

function changeMonth(){
currentMonth=document.getElementById("monthSelect").value;
}

function addMonth(){
if(role!=="superadmin")return;
let name=prompt("Yangi oy (2025-4)");
if(!name)return;
let data=getData();
if(!data[name])data[name]={};
saveData(data);
currentMonth=name;
loadMonths();
}

/* ================= MENU ================= */

function loadMenu(){
let m=document.getElementById("menu");
m.innerHTML="";
m.innerHTML+=`<div class="btn" onclick="openAudit()">Аудит</div>`;
m.innerHTML+=`<div class="btn" onclick="openAuditBall()">Аудит Балл</div>`;
if(role==="superadmin")m.innerHTML+=`<div class="btn" onclick="addMonth()">+ Oy</div>`;
}

/* ================= AUDIT ================= */

let currentBranch="";
let currentIndex=0;
let tempMarks={};
let tempImages={};

function openAudit(){
document.getElementById("menu").style.display="none";
let html=`<div class="back" onclick="back()">Orqaga</div>`;
branches.forEach(b=>{
html+=`
<div class="card">
<b>${b}</b><br>
<button onclick="openAuditForm('${b}',0)">Audit 1</button>
<button onclick="openAuditForm('${b}',1)">Audit 2</button>
</div>`;
});
document.getElementById("content").innerHTML=html;
}

function openAuditForm(branch,index){

currentBranch=branch;
currentIndex=index;

let data=getData();
let existing=data[currentMonth]?.[branch]?.audits?.[index];

let html=`<div class="back" onclick="openAudit()">Orqaga</div>`;
html+=`<div class="card"><b>${branch} - Audit ${index+1}</b></div>`;

questions.forEach((q,i)=>{
let savedMark=existing?.marks?.[i];
let savedImage=existing?.images?.[i];

html+=`<div class="card">`;
html+=`<p>${q.text}</p>`;

if(existing){
if(savedMark){
html+=`<div class="${savedMark==="good"?"scoreGreen":"scoreRed"}">
${savedMark==="good"?"✔ Yaxshi":"❌ Yomon"}
</div>`;
}
if(savedImage){
html+=`<img src="${savedImage}" onclick="openImage('${savedImage}')">`;
}
}else{
if(role!=="viewer"){
html+=`
<button onclick="mark(${i},'good')" id="g${i}">✔</button>
<button onclick="mark(${i},'bad')" id="b${i}">✖</button>
<input type="file" accept="image/*" onchange="uploadImage(event,${i})">
`;
}else{
html+=`<div class="locked">Audit hali qilinmagan</div>`;
}
}

html+=`</div>`;
});

if(!existing && role!=="viewer"){
html+=`<button onclick="finishAudit()">Tugatish</button>`;
}

document.getElementById("content").innerHTML=html;
}

function mark(i,type){
tempMarks[i]=type;
if(type==="good"){
document.getElementById("g"+i).classList.add("good");
document.getElementById("b"+i).classList.remove("bad");
}else{
document.getElementById("b"+i).classList.add("bad");
document.getElementById("g"+i).classList.remove("good");
}
}

function uploadImage(event,index){
let file=event.target.files[0];
if(!file)return;
let reader=new FileReader();
reader.onload=function(e){
tempImages[index]=e.target.result;
};
reader.readAsDataURL(file);
}

function finishAudit(){
if(role==="viewer")return;
let score=100;
questions.forEach((q,i)=>{if(tempMarks[i]==="bad")score-=q.minus;});
let data=getData();
if(!data[currentMonth])data[currentMonth]={};
if(!data[currentMonth][currentBranch])
data[currentMonth][currentBranch]={audits:[null,null]};
data[currentMonth][currentBranch].audits[currentIndex]={
score:score,
marks:tempMarks,
images:tempImages,
date:new Date().toLocaleString()
};
saveData(data);
alert("Audit saqlandi ✅ Ball: "+score);
openAudit();
}

/* ================= IMAGE VIEW ================= */

function openImage(src){
let w=window.open("");
w.document.write("<img src='"+src+"' style='width:100%'>");
}

/* ================= BALL ================= */

function openAuditBall(){
document.getElementById("menu").style.display="none";
let data=getData();
let html=`<div class="back" onclick="back()">Orqaga</div>`;
branches.forEach(b=>{
let audits=data[currentMonth]?.[b]?.audits||[null,null];
let avg=0;
if(audits[0]&&audits[1])avg=Math.round((audits[0].score+audits[1].score)/2);
else if(audits[0])avg=audits[0].score;
else if(audits[1])avg=audits[1].score;
html+=`<div class="card"><b>${b}</b> : ${avg}</div>`;
});
document.getElementById("content").innerHTML=html;
}

/* ================= GENERAL ================= */

function back(){
document.getElementById("content").innerHTML="";
document.getElementById("menu").style.display="grid";
}

function logout(){
localStorage.clear();
window.location="index.html";
}

/* Devtools block (oddiy user uchun) */
document.addEventListener("contextmenu",e=>e.preventDefault());
document.onkeydown=function(e){
if(e.keyCode==123)return false;
if(e.ctrlKey&&e.shiftKey&&e.keyCode==73)return false;
};

loadMonths();
loadMenu();

</script>
</body>
</html>
